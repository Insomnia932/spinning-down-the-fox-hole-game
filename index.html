<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spinning Down the Fox Hole - Playable</title>

<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CCVMTT7KFE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-CCVMTT7KFE');
</script>

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
<style>
body { margin:0; overflow:hidden; font-family:Arial,sans-serif; background:#020024; }
canvas { display:block; position:absolute; top:0; left:0; z-index:1; }

.menu { 
  position:absolute; top:0; left:0; width:100%; height:100%;
  background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center;
  z-index:10; transition:opacity 0.3s; 
}
.menu.hidden { opacity:0; pointer-events:none; }
.menu-title { display:flex; align-items:center; justify-content:center; margin-bottom:25px; }
.menu-title .title-block { display:flex; flex-direction:column; align-items:center; }
.menu-title .title-block h1 { font-family: 'Great Vibes', cursive; color: gold; font-size:48px; margin:0; text-align:center; line-height:1; }
.menu-title img { width:150px; height:auto; }
.menu-title .left { transform:scaleX(-1); } 
.menu button { font-size:26px; padding:12px 30px; margin:8px; border:none; border-radius:10px; background:linear-gradient(180deg,#000,#222); color: gold; cursor:pointer; width:220px; transition:0.3s; }
.menu button:hover { background:linear-gradient(180deg,#333,#555); }

#pauseBtn, #exitFullscreenBtn { position:absolute; top:20px; right:20px; padding:10px 20px; font-size:20px; border:none; border-radius:8px; z-index:5; cursor:pointer; display:none; }
#pauseBtn { background:rgba(255,123,0,0.7); color:white; }
#exitFullscreenBtn { background:#222; color:gold; font-size:24px; }

#leaderboard {
  background: rgba(0,0,0,0.8);
  color: gold;
  padding: 20px;
  border-radius: 15px;
  max-height: 300px;
  overflow-y: auto;
  text-align: center;
  margin-top: 15px;
}
</style>
</head>
<body>

<div class="menu" id="mainMenu">
  <div class="menu-title">
    <img src="https://i.ibb.co/p6Lt7nNd/e2eb6366-b194-476b-a714-99a2449d34ba.png" class="left">
    <div class="title-block">
      <h1>Spinning Down</h1>
      <h1>The</h1>
      <h1>Fox Hole</h1>
    </div>
    <img src="https://i.ibb.co/p6Lt7nNd/e2eb6366-b194-476b-a714-99a2449d34ba.png" class="right">
  </div>
  <h2 id="bestScoreText">Top Score: 0</h2>
  <button id="playBtn">Play</button>
  <button id="continueBtn" style="display:none;">Continue</button>
  <button id="fullscreenBtn">Fullscreen</button>
  <div id="leaderboard"></div>
</div>

<div class="menu hidden" id="pauseMenu">
  <h1>Paused</h1>
  <button id="continueGameBtn">Continue</button>
  <button id="restartBtn">Restart</button>
  <button id="menuBtn">Main Menu</button>
</div>

<button id="pauseBtn">Pause</button>
<button id="exitFullscreenBtn">X</button>
<canvas id="gameCanvas"></canvas>

<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-database-compat.js"></script>
<script>
// ---------------------- FIREBASE ----------------------
const firebaseConfig = {
  apiKey: "AIzaSyBPZmWicpiQbaKWBWx48HBMaa4F46-5D4k",
  authDomain: "sdtfh-game.firebaseapp.com",
  databaseURL: "https://sdtfh-game-default-rtdb.firebaseio.com",
  projectId: "sdtfh-game",
  storageBucket: "sdtfh-game.firebasestorage.app",
  messagingSenderId: "857298673539",
  appId: "1:857298673539:web:1d8afecec739fe92cfa0b6",
  measurementId: "G-CCVMTT7KFE"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------------- CANVAS ----------------------
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// ---------------------- IMAGES ----------------------
const foxImg = new Image(); foxImg.src = "https://i.ibb.co/p6Lt7nNd/e2eb6366-b194-476b-a714-99a2449d34ba.png";
const obstacleImg = new Image(); obstacleImg.src = "https://i.ibb.co/SwGYdXP8/file-00000000fa906206a0873428ec82c8a9.png";
const heartImg = new Image(); heartImg.src = "https://i.ibb.co/0jsR2xyJ/sketch1760895249408.png";

// ---------------------- GAME VARIABLES ----------------------
let foxWidth=120, foxHeight=120, foxX=50, foxY=canvas.height-foxHeight-50;
let velocityY=0, gravity=0.7, groundHeight=50;
let obstacles=[], fireballs=[];
let gameSpeed=5, score=0, lives=3;
let jumpCount=0, maxJumps=3;
let isPaused=true, isGameOver=false;

// ---------------------- HIGH SCORES ----------------------
let topScores = [];
const bestScoreText = document.getElementById("bestScoreText");
const leaderboardDiv = document.getElementById("leaderboard");

function loadTopScores(){
  db.ref('scores').orderByChild('score').limitToLast(10).once('value')
    .then(snapshot => {
      if(snapshot.exists()){
        topScores = Object.values(snapshot.val()).sort((a,b)=>b.score-a.score);
        bestScoreText.textContent = `Top Score: ${topScores[0]?.score || 0}`;
        displayLeaderboard();
      } else {
        topScores = [];
        bestScoreText.textContent = "Top Score: 0";
        leaderboardDiv.innerHTML = "<p>No high scores yet!</p>";
      }
    }).catch(err=>console.error("Firebase load error:", err));
}

function saveScore(name, score){
  db.ref('scores').push({name, score, timestamp: Date.now()})
    .then(()=> loadTopScores())
    .catch(err=>console.error("Firebase save error:", err));
}

function displayLeaderboard(){
  leaderboardDiv.innerHTML = "<h3>üèÜ Top 10 High Scores üèÜ</h3>";
  topScores.forEach((entry,index)=>{
    leaderboardDiv.innerHTML += `<p>${index+1}. ${entry.name} - ${entry.score}</p>`;
  });
}

// ---------------------- FOREST & BACKGROUND ----------------------
let forestLayers = [
  {color:"#0b0f3a", speed:0.5, height:200},
  {color:"#2e004f", speed:1, height:180},
  {color:"#034d03", speed:1.5, height:150}
];
let forestPositions = forestLayers.map(layer => {
  let positions = [];
  for (let x = 0; x < canvas.width + 50; x += 50) {
    positions.push({x:x, height:layer.height + Math.random() * 50});
  }
  return positions;
});
let mountains = [
  {color:"#1b1b1b", speed:0.2, peaks:[], baseHeight:300},
  {color:"#2c2c2c", speed:0.35, peaks:[], baseHeight:220}
];
mountains.forEach(layer=>{
  for(let x=0;x<canvas.width+100;x+=50){
    layer.peaks.push({x:x, height:layer.baseHeight + Math.random()*150});
  }
});
let stars=[]; 
for(let i=0;i<100;i++) stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height*0.5, size:Math.random()*2+1});
let moon={x:canvas.width*0.8, y:canvas.height*0.15, radius:60, glow:25};

// ---------------------- INPUT ----------------------
function jump(){ if(isPaused||isGameOver) return; if(jumpCount<maxJumps){ velocityY=-16; jumpCount++; } }
document.addEventListener("keydown", e=>{ if(e.code==="Space") jump(); });
document.addEventListener("touchstart", jump);

// ---------------------- FULLSCREEN ----------------------
const fullscreenBtn = document.getElementById("fullscreenBtn");
const exitFullscreenBtn = document.getElementById("exitFullscreenBtn");
fullscreenBtn.onclick = ()=>{
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen().then(()=>{ exitFullscreenBtn.style.display="block"; });
  }
};
exitFullscreenBtn.onclick = ()=>{
  if(document.fullscreenElement) document.exitFullscreen();
};

// ---------------------- MENU BUTTONS ----------------------
const mainMenu=document.getElementById("mainMenu");
const pauseMenu=document.getElementById("pauseMenu");
const playBtn=document.getElementById("playBtn");
const continueBtn=document.getElementById("continueBtn");
const continueGameBtn=document.getElementById("continueGameBtn");
const restartBtn=document.getElementById("restartBtn");
const menuBtn=document.getElementById("menuBtn");
const pauseBtn=document.getElementById("pauseBtn");

playBtn.onclick=startGame;
continueBtn.onclick=resumeGame;
restartBtn.onclick=restartGame;
menuBtn.onclick=returnToMenu;
pauseBtn.onclick=()=>{ if(!isPaused&&!isGameOver) pauseGame(); };
continueGameBtn.onclick=resumeGame;

// ---------------------- SPAWN & UPDATE ----------------------
function spawnObstacle() { obstacles.push({x:canvas.width+50, y:canvas.height-groundHeight-(80+Math.random()*40), width:(80+Math.random()*40)*0.7, height:80+Math.random()*40, scored:false, hit:false}); }
function spawnFireball() { fireballs.push({x:canvas.width+50, y:canvas.height-groundHeight-70-Math.random()*30, radius:20, passed:false, hit:false}); }
function updateObstacles() { obstacles.forEach(obs=>{ obs.x-=gameSpeed; if(!obs.scored && obs.x + obs.width < foxX){ obs.scored=true; score+=1; } }); obstacles = obstacles.filter(obs=>obs.x+obs.width>0); if(obstacles.length===0 || obstacles[obstacles.length-1].x<canvas.width-400) spawnObstacle(); }
function updateFireballs() { fireballs.forEach(f=>{ f.x -= gameSpeed+1; if(!f.passed && f.x+f.radius*2<foxX){ f.passed=true; score+=5; } }); fireballs = fireballs.filter(f=>f.x+f.radius*2>0); if(fireballs.length===0 && Math.random()<0.02) spawnFireball(); }

// ---------------------- COLLISIONS ----------------------
function detectCollisions(){
  obstacles.forEach(obs=>{ if(!obs.hit && foxX+foxWidth*0.6>obs.x && foxX<obs.x+obs.width*0.6 && foxY+foxHeight>obs.y && foxY<obs.y+obs.height){ lives--; obs.hit=true; } });
  fireballs.forEach(f=>{ if(!f.hit && foxX+foxWidth*0.6>f.x && foxX<f.x+f.radius*2 && foxY+foxHeight>f.y && foxY<f.y+f.radius*2){ lives--; f.hit=true; } });
  if(lives<=0) gameOver();
}

// ---------------------- DRAW FUNCTIONS ----------------------
function drawObstacles(){ obstacles.forEach(obs=>ctx.drawImage(obstacleImg, obs.x, obs.y, obs.width, obs.height)); }
function drawFireballs(){ fireballs.forEach(f=>{ ctx.save(); let grad=ctx.createRadialGradient(f.x+f.radius,f.y+f.radius,5,f.x+f.radius,f.y+f.radius,f.radius); grad.addColorStop(0,"orange"); grad.addColorStop(1,"rgba(255,0,0,0.5)"); ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(f.x+f.radius,f.y+f.radius,f.radius,0,Math.PI*2); ctx.fill(); ctx.restore(); }); }
function drawHUD(){ ctx.fillStyle="white"; ctx.font="24px Arial"; ctx.fillText("Score: "+score,20,40); ctx.fillText("Top Score: "+(topScores[0]?.score||0),20,70); for(let i=0;i<lives;i++){ ctx.drawImage(heartImg,20+i*45,100,40,40); } }

// ---------------------- DRAW BACKGROUND ----------------------
function drawBackground(){
  ctx.fillStyle="#020024"; ctx.fillRect(0,0,canvas.width,canvas.height);
  stars.forEach(s=>{ ctx.fillStyle="white"; ctx.beginPath(); ctx.arc(s.x,s.y,s.size,0,Math.PI*2); ctx.fill(); s.x-=0.2; if(s.x<0) s.x=canvas.width; });
  ctx.save();
  let grad=ctx.createRadialGradient(moon.x,moon.y,moon.radius-15,moon.x,moon.y,moon.radius+moon.glow);
  grad.addColorStop(0,"rgba(255,255,230,0.9)"); grad.addColorStop(1,"rgba(200,180,255,0.3)");
  ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(moon.x,moon.y,moon.radius+moon.glow,0,Math.PI*2); ctx.fill(); ctx.restore();
  mountains.forEach(layer=>{ ctx.fillStyle=layer.color; ctx.beginPath(); ctx.moveTo(0,canvas.height); layer.peaks.forEach(p=>{ p.x-=layer.speed; if(p.x<-50) p.x=canvas.width+Math.random()*100; ctx.lineTo(p.x,canvas.height-p.height); }); ctx.lineTo(canvas.width,canvas.height); ctx.closePath(); ctx.fill(); });
  forestLayers.forEach((layer,li)=>{ forestPositions[li].forEach(tree=>{ tree.x-=layer.speed; if(tree.x<-50) tree.x=canvas.width; ctx.fillStyle="#1a1a1a"; ctx.fillRect(tree.x,canvas.height-groundHeight-tree.height,10,tree.height); }); });
  ctx.fillStyle="#111"; ctx.fillRect(0,canvas.height-groundHeight,canvas.width,groundHeight);
}

// ---------------------- GAME LOOP ----------------------
function gameLoop(){
  drawBackground();
  if(!isPaused&&!isGameOver){
    velocityY+=gravity; foxY+=velocityY;
    if(foxY+foxHeight>=canvas.height-groundHeight){ foxY=canvas.height-foxHeight-groundHeight; velocityY=0; jumpCount=0; }
    updateObstacles();
    updateFireballs();
    detectCollisions();
    gameSpeed = score<150 ? 5 : score<300 ? 7 : 9;
  }
  ctx.drawImage(foxImg,foxX,foxY,foxWidth,foxHeight);
  drawObstacles(); drawFireballs(); drawHUD();
  requestAnimationFrame(gameLoop);
}
gameLoop();

// ---------------------- GAME FUNCTIONS ----------------------
function startGame(){ 
  mainMenu.classList.add("hidden"); 
  continueBtn.style.display="block"; 
  isPaused=false; 
  isGameOver=false; 
  pauseBtn.style.display="block"; 
  resetGame(); 
  spawnObstacle(); 
  spawnFireball(); 
  gtag('event','game_start'); // GA event
}
function pauseGame(){ isPaused=true; pauseMenu.classList.remove("hidden"); }
function resumeGame(){ isPaused=false; pauseMenu.classList.add("hidden"); }
function restartGame(){ pauseMenu.classList.add("hidden"); isPaused=false; isGameOver=false; resetGame(); spawnObstacle(); spawnFireball(); gtag('event','game_start'); }
function returnToMenu(){ isPaused=true; pauseMenu.classList.add("hidden"); mainMenu.classList.remove("hidden"); pauseBtn.style.display="none"; loadTopScores(); }
function resetGame(){ foxY=canvas.height-foxHeight-groundHeight; velocityY=0; obstacles=[]; fireballs=[]; score=0; lives=3; jumpCount=0; gameSpeed=5; }

// ---------------------- GAME OVER ----------------------
function gameOver(){ 
  isGameOver=true; 
  isPaused=true; 
  pauseBtn.style.display="none"; 
  gtag('event','game_over',{score:score}); // GA event
  let playerName = prompt("Enter your name:","Anonymous") || "Anonymous"; 
  saveScore(playerName,score); 
  alert(`Game Over! Score: ${score}\nTop Score: ${topScores[0]?.score || 0} by ${topScores[0]?.name}`); 
  returnToMenu();
}

// ---------------------- INITIAL LOAD ----------------------
loadTopScores();
</script>
</body>
</html>
